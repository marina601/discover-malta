{% extends 'base.html' %}
{% load static %}

{% block extra_title %} {{ trip.name }} {% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'trips/css/trips.css' %}">
    <link rel="stylesheet" href="{% static 'trips/css/star-rating.css' %}">
{% endblock %}

{% block content %}
<section class="main-content">
    <div class="container">
        <!--heading-->
        <div class="row">
            <div class="col-s12 mt-1">
                <h1 class="text-center heading">{{ trip.name }}</h1>
            </div>
        </div>
        <div class="row">
            <div class="col">
                 <!--Add to favourite link-->
                {% if user.is_authenticated %}
                {% if favourites %}
                <a href="{% url 'add_to_favourite' trip.id %}" class="btn btn-lg btn-favourite add-to-favourites"
                    data-bs-toggle="tooltip" data-bs-placement="top" title="Remove this trip from favourites">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                    <span class="sr-only">remove from favourites</span>
                </a>
                {% else %}
                <a href="{% url 'add_to_favourite' trip.id %}" class="btn btn-lg btn-favourite add-to-favourites"
                    data-bs-toggle="tooltip" data-bs-placement="top" title="Add to favourites">
                    <i class="fas fa-heart" aria-hidden="true"></i>
                    <span class="sr-only">add to favourites</span>
                </a>
                {% endif %}
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-lg btn-favourite add-to-favourites" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="Please login to add this trip to your favourites">
                    <i class="fas fa-heart" aria-hidden="true"></i>
                    <span class="sr-only">login to add this trip to favourites</span>
                </a>
                {% endif %}
                <!--Trip Image-->
                <img src="{{ trip.images.url }}" class="card-img-top" alt="{{ trip.name }}">
            </div>
        </div>
        <!--Trip Details-->
        <div class="row mt-2">
            <div class="col-lg-6 col-md-6 col-sm-12">
                <ul class="list-group">
                    <!--Duration-->
                    <li class="list-group-item">
                        <i class="fas fa-hourglass-end fa-lg" aria-hidden="true"></i>
                        <strong> Duration: </strong>
                        {{ trip.duration }}hrs
                    </li>
                    <!--Start Time-->
                    <li class="list-group-item">
                        <i class="far fa-clock fa-lg" aria-hidden="true"></i>
                        <strong>Start Time: </strong>
                        {{ trip.start_time }}
                    </li>
                    <!--Departure Location-->
                    <li class="list-group-item">
                        <i class="fas fa-map-marked-alt fa-lg" aria-hidden="true"></i>
                        <strong> Departure Location:
                        </strong> {{ trip.departure_location }}
                    </li>
                    <!--Price-->
                    <li class="list-group-item">
                        <i class="fas fa-euro-sign fa-lg" aria-hidden="true"></i>
                        <span class="sr-only">euro</span>
                        {{ trip.adult_price }}
                        <strong>per adult</strong>
                    </li>
                    {% if trip.child_price > 0 %}
                    <li class="list-group-item">
                        <i class="fas fa-euro-sign fa-lg" aria-hidden="true"></i>
                        <span class="sr-only">euro</span>
                        {{ trip.child_price }}
                        <strong>per child above 4yrs</strong>
                    </li>
                    {% endif %}
                    <!--Star rating-->
                    {% if trip.averageRating > 0 %}
                    <li class="list-group-item">
                        <i class="fas fa-star fa-lg" aria-hidden="true"></i>
                        <span class="sr-only">rating</span>
                        {{ trip.averageRating|floatformat:1 }} /5
                    </li>
                    {% else %}
                    <li class="list-group-item">
                        <i class="fas fa-star fa-lg text-black" aria-hidden="true"></i>
                        No rating yet
                    </li>
                    {% endif %}
                    <!--Reviews-->
                    {% if trip.totalReviews > 0 %}
                    <li class="list-group-item">
                        <i class="fas fa-comments" aria-hidden="true"></i>
                        {{ trip.totalReviews }} reviews
                    </li>
                    {% else %}
                    <li class="list-group-item">
                        <i class="fas fa-comments" aria-hidden="true"></i>
                        No reviews yet
                    </li>
                    {% endif %}
                    <!--Family Friendly-->
                    {% if trip.family_friendly %}
                    <li class="list-group-item">
                        <i class="fas fa-child fa-lg" aria-hidden="true"></i>
                        <strong>Friendly Friendly</strong>
                    </li>
                    {% endif %}
                </ul>
            </div>
            {% if trip.num_tickets == 0 %}
            <button type="button" class="btn btn-md btn-next btn-book" disabled>
                Sold Out
            </button>
            {% else %}
            <!--Booking Modal-->
            <div class="col-lg-6 col-md-6 col-sm-12">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-md btn-next btn-book" data-bs-toggle="modal"
                    data-bs-target="#exampleModal">
                    Book Now
                </button>
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content review-form">
                            <!--form-->
                            <form action="{% url 'add_to_bag' trip.id %}" method="POST">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">{{ trip.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <label for="total_adults"><strong>Number of Adults:</strong></label>
                                            <i class="fas fa-user-friends"></i>
                                            <input type="number" id="total_adults" class="from-control"
                                                name="adult_tickets" min="1" max="8" value="0"
                                                oninput="this.setCustomValidity('')"
                                                oninvalid="this.setCustomValidity('At least 1 adult ticket is required to purchase a trip')"
                                                required>
                                            <p> @ <i class="fas fa-euro-sign"></i> {{ trip.adult_price }} <span
                                                    class="text-muted "> per person</span></p>
                                        </div>
                                        {% if trip.family_friendly %}
                                        <div class="col-lg-4">
                                            <label for="children_tickets"><strong>Number of Children:</strong></label>
                                            <i class="fas fa-child"></i>
                                            <input type="number" id="children_tickets" class="from-control"
                                                name="children_tickets" value="0" min="0" max="9">
                                            <p> @ <i class="fas fa-euro-sign"></i> {{ trip.child_price }} <span
                                                    class="text-muted ">per child</span></p>
                                        </div>
                                        {% else %}
                                        <div class="col-lg-4 d-none">
                                            <label for="children_tickets">Select Number of Children:</label>
                                            <input type="number" id="children_tickets" class="from-control"
                                                name="children_tickets" value="0" min="0" max="9">
                                        </div>
                                        {% endif %}
                                        <div class="col-lg-4">
                                            <p><strong>Select the Date: </strong><i class="far fa-calendar-alt"></i>
                                                <input type="text" class="calendar form-control" name="booking_date"
                                                    id="datepicker" oninput="this.setCustomValidity('')"
                                                    oninvalid="this.setCustomValidity('Please select the date for your trip')"
                                                    required>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="row">
                                        <div class="col modal-btn">
                                            <button type="button" class="btn btn-lg btn-secondary"
                                                data-bs-dismiss="modal">
                                                <i class="fas fa-times"></i> Close</button>
                                            <button type="submit" class="btn btn-lg add-booking-btn">
                                                Add to <i class="fas fa-suitcase-rolling"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="redirect_url" value="{{ request.path }}">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <!--Full Description-->
        <div class="row mt-2">
            <div class="col">
                <h2>Full Description</h2>
                <p>{{ trip.full_description }}</p>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col">
                <h3>What is Included</h3>
                <p>{{ trip.included }}</p>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col">
                <h3>What to Bring</h3>
                <p>{{ trip.what_to_bring }}</p>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col">
                <h4>Cancellation Policy</h4>
                <p>You may cancel your trip 24hrs in advance to get a full refund.
                    Any trips cancelled less than 24hrs in advance will not qualify for a refund.
                </p>
            </div>
        </div>
        <!--Delete/Update Trip-->
        {% if user.is_superadmin %}
        <div class="row mt-2">
            <div class="col d-flex justify-content-end">
                <!--Delete Trip Modal-->
                {% include 'trips/includes/delete-modal-trip.html' %}
                <a href="{% url 'update_trip' trip.id %}" class="btn update-link m-1">
                    Update <i class="fas fa-sync" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        {% endif %}
        {% if user.is_authenticated %}
        <div class="row m-1">
            <!--User Reviews-->
            <form action="{% url 'submit_review' trip.id  user.id %}" method="POST"
                class="col-lg-8 offset-lg-2 col-md-8 offset-md-2 col-sm-12 login-form" id="review-form">
                {% csrf_token %}
                <h4 class="text-center m-2">Review this Trip</h4>
                 <p>How would you rate this trip?</p>
                <!--Star Rating-->
                <fieldset class="rating">
                    <input type="radio" id="rating10" name="rating" value="5" />
                    <label for="rating10" title="5 stars"></label>
                    <input type="radio" id="rating9" name="rating" value="4.5" />
                    <label class="half" for="rating9" title="4.5 stars"></label>
                    <input type="radio" id="rating8" name="rating" value="4" />
                    <label for="rating8" title="4 stars"></label>
                    <input type="radio" id="rating7" name="rating" value="3.5" />
                    <label class="half" for="rating7" title="3.5 stars"></label>
                    <input type="radio" id="rating6" name="rating" value="3" />
                    <label for="rating6" title="3 stars"></label>
                    <input type="radio" id="rating5" name="rating" value="2.5" />
                    <label class="half" for="rating5" title="2.5 stars"></label>
                    <input type="radio" id="rating4" name="rating" value="2" />
                    <label for="rating4" title="2 stars"></label>
                    <input type="radio" id="rating3" name="rating" value="1.5" />
                    <label class="half" for="rating3" title="1.5 stars"></label>
                    <input type="radio" id="rating2" name="rating" value="1" />
                    <label for="rating2" title="1 star"></label>
                    <input type="radio" id="rating1" name="rating" value="0.5" required />
                    <label class="half" for="rating1" title="0.5 star"></label>
                </fieldset>
                <!--Review Title-->
                <div class="col">
                    <label for="subject" class="form-label">Review Title:</label>
                    <input type="text" name="subject" id="subject" class="form-control" minlength="5" maxlength="50"
                       oninput="this.setCustomValidity('')"
                       oninvalid="this.setCustomValidity('Please give your review a title')"
                    required>
                </div>
                <!--Review -->
                <div class="col">
                    <label for="review" class="form-label">Review:</label>
                    <textarea name="review" id="review" rows="5" class="form-control"></textarea>
                </div>
                <div class="col text-center">
                    <button type="submit" class="btn btn-dropdown" id="btn-submit">Submit Review</button>
                </div>
            </form>
        </div>
        {% else %}
        <hr>
        <div class="row spacing">
            <div class="col-">
                <h4 class="d-md-inline"> Have you been on this trip? Please rate your experience</h4>
                <a class="btn btn-dropdown d-md-inline" href="{% url 'login' %}">Login</a>
            </div>
        </div>
        {% endif %}
        <div class="row spacing">
            <div class="col text-center">
                <h3 class="text-center">Customer Reviews</h3>
                {% if trip.totalReviews > 0 %}
                <span class="text-muted">There are {{ trip.totalReviews }} reviews for this trip</span>
                {% endif %}
            </div>
        </div>
        {% if reviews %}
        <div class="row m-1">
            {% for review in reviews %}
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="card mb-3 review-card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <h5 class="card-title">{{ review.subject }}</h5>
                            </div>
                        </div>
                        <div class="row">
                        <div class="col">
                            <div class="star-rating">
                                <i class="fas fa-star{% if review.rating == 0.5 %}-half{% elif review.rating < 1 %}-o{%endif%}" aria-hidden="true"></i>
                                <i class="fas fa-star{% if review.rating == 1.5 %}-half{% elif review.rating < 2 %}-o{%endif%}" aria-hidden="true"></i>
                                <i class="fas fa-star{% if review.rating == 2.5 %}-half{% elif review.rating < 3 %}-o{%endif%}" aria-hidden="true"></i>
                                <i class="fas fa-star{% if review.rating == 3.5 %}-half{% elif review.rating < 4 %}-o{%endif%}" aria-hidden="true"></i>
                                <i class="fas fa-star{% if review.rating == 4.5 %}-half{% elif review.rating < 5 %}-o{%endif%}" aria-hidden="true"></i>
                                <span class="sr-only">rating {{ review.rating }} stars out of 5</span>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col">
                            <p class="card-text">{{ review.review }}</p>
                        </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-12 mb-1">
                                <img src="{{ review.user.userprofile.profile_img.url }}"
                                    class="img-fluid img-thumbnail rounded-circle" alt="user profile image">
                            </div>
                            <div class="col-md-8 col-sm-8 mt-1">
                                <h6 class="d-inline"><span class="text-muted">by</span>
                                    {{ review.user.first_name|capfirst }}</h6>
                                {% if review.updated_at %}
                                <p class="card-text d-inline"><small class="text-muted">Updated on:
                                        {{ review.updated_at|date:"M d, Y" }}</small></p>
                                {% else %}
                                <p class="card-text d-inline"><small class="text-muted">Created on:
                                        {{ review.created_at|date:"M d, Y" }}</small></p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            {% if user == review.user %}
                            <div class="col">
                                {% include 'trips/includes/delete-modal-review.html' %}
                                <a href="{% url 'edit_review' review.id %}" class="d-inline btn update-link m-1">
                                    Update <i class="fas fa-sync" aria-hidden="true"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="col">
                <p class="text-center">This Trip does not have any reviews yet.</p>
            </div>
        {% endif %}
        <div class="row">
            <div class="col justify-content-center btn-div">
                <a href="{% url 'trips' %}" class="btn btn-lg btn-next">Go Back to All Trips</a>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block postloadjs %}

     <script src="{% static 'trips/js/modal.js' %}"></script>

{% endblock %}
